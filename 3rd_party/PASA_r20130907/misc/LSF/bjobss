#!/usr/bin/env perl

use strict;
#use warnings;

my $waittime = 30;

my $max_display = 20; # doesn't include extras by username.

my $USER = $ENV{USER};

# example entry:
#8417150 ferreir PEND  long       silver.broa             *.sh 18 20 Jun  2 18:50    

my @status_types = qw (
                       RUN
                       PEND
                       SSUSP
                       STAT
                       UNKWN
                       USUSP 
                       );

while (1) {
    my @results = `bjobs -u all`;

    my %totals;
    
    my %data;
    
    # build the table header:
    my $report = sprintf("%10s %10s", "USER", "QUEUE");
    foreach my $status_type (@status_types) {
        $report .= sprintf ("%10s", $status_type);
    }
    $report .= "\n";
    
    # build the rest of the report
    
	foreach my $result (@results) {
        my ($job_id, $name, $status, $queuename, $submitting_server, @rest) = split (/\s+/, $result);
        
        $data{"$name$;$queuename"}->{$status}++;
        
        $totals{"$name$;$queuename"}++;
    }
    
    my $count = 0;
    
	my @totals;
	foreach my $submitter (reverse sort {$totals{$a}<=>$totals{$b}} keys %data) {
        
        $count++;

        my ($user, $queue) = split (/$;/, $submitter);
        
        my $outline;
        if ($user eq $USER) {
            $outline = sprintf ("%10s %10s", "\*$user\*", $queue);
        }
        else {
            $outline = sprintf ("%10s %10s", $user, $queue);
        }
        
		my $status_no = 0;
        foreach my $status (@status_types) {
            my $count = $data{$submitter}->{$status} || 0;
            
            $outline .= sprintf ("%10d", $count);
			$totals[$status_no] += $count;
			$status_no++;
		}

        $outline .= "\n";
        
        if ($count <= $max_display || $user eq $USER) {
            $report .= $outline;
        }
        
    }
	$report .= sprintf("%10s %10s", "Totals", "------");
	foreach my $sum (@totals) {
		$report .= sprintf("%10d", $sum);
	}
	$report .= "\n";
	
    system ("clear");
    print $report . "\n\n" . `date`;
        
    sleep($waittime);

}


exit(0);
