#!/usr/local/bin/perl

use lib ($ENV{EGC_SCRIPTS});
use Egc_library;
use DBI;
use strict;

our $DEBUG = 0;
our $SEE = 0;

my $usage = "\n\nusage: $0 db coordsFile\n\n";

my $fasta_file = "max_gene_spans"; 
my $ev_type = "alignAssembly";
my $db = $ARGV[0] or die $usage;
my $coordsFile = $ARGV[1] or die $usage;

my ($dbproc) = &ConnectToDb("SYBTIGR","Sybase","egc", "egcpwd","$db");

&ensure_common_search_db_listing($fasta_file);
&load_coords($coordsFile);



###############
sub load_coords {
    my ($coordsfile) = @_;
    
    ## Before parsing the coords, make sure the fasta_file db has an id in common..search_dbs
    if ($fasta_file =~ /\/(\S+)$/) { #get core filename, not full-path.
	$fasta_file = $1;
    }
    $fasta_file = substr ($fasta_file, 0, 25); 
    my $query = "select id from common..search_dbs where name = \"$fasta_file\" and iscurrent = 1\n";
    my @results = &do_sql ($dbproc, $query);
    my $db_id;
    unless ($db_id = $results[0]) {
	warn "The fasta_file $fasta_file is not listed as a db in common..search_dbs\n"
	    .  "and therefore, will not be loaded into the annotation database: $db\n";
	return;
    }
    
    
    open (my $fh, $coordsfile) or die $!;
    while (<$fh>) {
	print;
	s/,//g;
	chomp;
	my ($trace, $asmbl_id, $accession, $end5, $end3) = split (/\s+/);
	
	my $length = abs($end3-$end5) + 1;
	foreach my $coordset ([$end5,$end3], [$end3,$end5]) {
	    my ($curr_end5, $curr_end3) = (@$coordset);
	    
	    
	    my $query = "insert evidence (feat_name, m_lend, m_rend, end5, end3, change_log, save_history, accession, assignby, curated, ev_type, method,  rel_end5, rel_end3, date, db) values (\"$asmbl_id.intergenic\", 1, $length, $curr_end5, $curr_end3, 0, 0, \"$accession\", \"bhaas\", 0, \"$ev_type\", \"maxspan_db_loader\",  0,0,getdate(), \"$db_id\")";
	    print "$query\n\n" if $DEBUG||$SEE;

	    
	    &RunMod ($dbproc, $query);
	}
    }
}
	

####
sub ensure_common_search_db_listing {
    my ($fasta_file) = shift;
    ## see if already exists
    $fasta_file = substr ($fasta_file, 0, 25); #varchar field in db of length 25
    my $query = "select count(*) from common..search_dbs where name = \"$fasta_file\" and iscurrent = 1";
    my $exists = &first_result_sql ($dbproc, $query);
    unless ($exists) { #insert a row.
	my $query = "insert common..search_dbs (name, release_notes, date, assignby, iscurrent, type) values (\"$fasta_file\", \"custom database\", getdate(), \"egc\", 1, \"custom\")";
	&RunMod($dbproc, $query);
	if ($QUERYFAIL) {
	    die "Sorry, could not find your database $fasta_file listed in common..search_dbs, and I failed in trying to create a listing for it there.\n";
	}
    }
}
























